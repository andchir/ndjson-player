/**
 * Author : A.Lepe (dev@alepe.com)
 * License: MIT
 * Version: 0.1.8
 * Updated: 2022-04-26
 * Content: ndjson-player.min.js (Minimized)
 */

class NdJsonPlayer{fps;loop;showfirst;autoplay;path;playing=!1;loaded=!1;backwards=!1;started=!1;onStart;onLoad;onRender;onFinish;onError;player=null;canvas=null;ctx=null;timer=null;src="";frame=0;multiplier=1;_numFrames=0;_totTime=0;_frames=[];_frameBase="";_startTimeStamp=0;constructor(t,e,s,a,i,r,n,o){const h=this;h.src=t,window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame),h.onStart=a||function(){},h.onLoad=i||function(){},h.onRender=r||function(){},h.onFinish=n||function(){},h.onError=o||function(t){console.log(t)};let m=null;if(e instanceof Node)m=e;else{if("object"==typeof e)s=e,e="canvas";else if("string"!=typeof e)throw"Incorrect parameter passed to constructor of NdJsonPlayer";m=document.querySelector(e||"canvas")}if(!m)throw"Canvas element was not found in DOM: "+e;if("CANVAS"===m.tagName){h.canvas=m;const t=document.createElement("div");m.parentNode.insertBefore(t,m),t.prepend(m),m=t}else if(m.hasChildNodes()){if(h.canvas=m.querySelector("canvas"),!h.canvas)throw"No canvas found in element"}else h.canvas=document.createElement("CANVAS"),m.prepend(h.canvas);h.player=m,h.canvas.height=h.canvas.clientHeight,h.canvas.width=h.canvas.clientWidth,m.classList.add("ndjp"),h.ctx=h.canvas.getContext("2d"),h.fps=s.fps||24,h.loop=s.loop||!1,h.autoplay=s.autoplay||!1,h.showfirst=!1!==s.showfirst,h.path=s.path||"",h.timer=new TimerSrc(1e3/h.fps),h.load((function(t){void 0!==t.w&&(h.canvas.width=t.w),void 0!==t.h&&(h.canvas.height=t.h),void 0!==t.fb&&(h._frameBase=t.fb),void 0!==t.tf&&(h._numFrames=t.tf),void 0!==t.tt&&(h._totTime=t.tt),void 0!==t.ts&&(h._startTimeStamp||(h._startTimeStamp=t.ts)),void 0!==t.fps&&(h.fps=t.fps,h.timer=new TimerSrc(1e3/h.fps)),void 0!==t.f?(h._frames.push(t),h.loaded||(h.loaded=!0,h.autoplay?h.play():h.showfirst&&h.step())):h.onRender(t),h.started||(h.onStart(h),h.started=!0)}))}load(t,e){const s=this;void 0!==e&&(this.src=e,this._frames=[]);const a=new TextDecoder;let i="";return fetch(s.src).then((t=>t.body.getReader())).then((e=>e.read().then((function r({value:n,done:o}){if(o)return t(JSON.parse(i)),void s.onLoad(s);const h=(i+a.decode(n,{stream:!0})).split(/[\r\n](?=.)/);return i=h.pop(),h.map(JSON.parse).forEach(t),e.read().then(r)})))).catch((t=>this.onError(t)))}_render(t){if(null==this.timer)throw"TimerSrc was not initialized";if(0===this._frames.length)throw"Video is empty or no frames were found";this.frame>=this._frames.length&&(this.frame=this.loop?0:this._frames.length-1),this.frame<0&&(this.frame=this.loop?this._frames.length-1:0),this._displayImg(t)}_displayImg(t){const e=this,s=e._frames[e.frame],a=function(){e.onRender(s),e.timer.call((function(){t||(e._increment(),e.timer.nocall()),e._displayImg()}))};if(void 0!==s.f){const t=e._frameBase+s.f;e._image(t,a)}else e.onRender(s),a()}_increment(){this.frame+=this.multiplier*(this.backwards?-1:1),this.frame<0&&(this.loop?this.frame=this._frames.length-1:(this.frame=0,this.pause(),this.onFinish(this))),this.frame>this._frames.length-1&&(this.loop?this.frame=0:(this.frame=this._frames.length-1,this.pause(),this.onFinish(this)))}_draw=function(t,e){const s=this;return 0===t.width&&0===t.height?(t.onerror(),void 0!==e&&e(!1)):(s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.ctx.drawImage(t,0,0,t.width,t.height,0,0,s.canvas.width,s.canvas.height),void 0!==e&&e(!0)),this};_image=function(t,e){const s=this,a=new Image;return a.crossOrigin="",a.onload=function(){s._draw(a,(function(t){t&&void 0!==e&&e(a)}))},a.onerror=function(){const t=s.onError();t&&(a.src=t)},a.src="/"===t[0]||t.match(/^https?:/)||t.match(/^data:image/)?t:s.path+t,this};frameBase(){return this._frameBase}currentFrame(){return this.frame}totalFrames(){return this._numFrames||this._frames.length}totalTime(){return this._totTime||this.currentFrame()/this.fps}frameAt(t){const e=this;let s=t<this.totalFrames()?e._frames[t]:null;return s&&(s.fb=e._frameBase),s}indexAt(t){return~~(t*this.totalFrames()/100)}playerNode(){return this.player}play(t){t<0?t=0:t>this._frames.length?t=this._frames.length-1:void 0!==t&&(this.frame=1*t),this.playing=!0,this.timer.play(),this._render(!1)}playForward(t){this.backwards=!1,this.play(t)}playBackwards(t){this.backwards=!0,this.play(t)}pause(){this.playing=!1,this.timer.pause()}stop(){this.playing=!1,this.frame=0,this.timer.pause(),this._displayImg(!0)}step(t){t<0?t=0:t>this._frames.length?t=this._frames.length-1:void 0!==t&&(this.frame=1*t),this.playing=!1,this.timer.step(),this._render(!0)}stepForwards(){this.backwards=!1,this.step()}stepBackwards(){this.backwards=!0,this.step()}reset(){return void 0!==this.ctx.reset&&(this.ctx.reset(),this.ctx.clear(),this.stop(),this.canvas.width=this.canvas.width),this}}
//# sourceMappingURL=ndjson-player.min.js.map
