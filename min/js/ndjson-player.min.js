/**
 * Author : A.Lepe (dev@alepe.com)
 * License: MIT
 * Version: 0.1.8
 * Updated: 2022-05-09
 * Content: ndjson-player.min.js (Minimized)
 */

class NdJsonPlayer{fps;loop;showfirst;autoplay;path;playing=!1;loaded=!1;backwards=!1;started=!1;onStart;onLoad;onRender;onPlay;onStop;onFinish;onError;wrapper=null;canvas=null;ctx=null;timer=null;src="";frame=0;multiplier=1;_numFrames=0;_totTime=0;_frames=[];_frameBase="";_thumbBase="";_startTimeStamp=0;constructor(t,e,s,a){const i=this;i.src=t,window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame);const r=()=>{};a=Object.assign({},a),i.onStart=a.onstart||r,i.onLoad=a.onload||r,i.onRender=a.onrender||r,i.onPlay=a.onplay||r,i.onStop=a.onstop||r,i.onFinish=a.onfinish||r,i.onError=a.onerror||(t=>{console.log(t)});let n=null;if(e instanceof Node)n=e;else{if("object"==typeof e)s=e,e="canvas";else if("string"!=typeof e)throw"Incorrect parameter passed to constructor of NdJsonPlayer";n=document.querySelector(e||"canvas")}if(!n)throw"Canvas element was not found in DOM: "+e;if("CANVAS"===n.tagName){i.canvas=n;const t=document.createElement("div");n.parentNode.insertBefore(t,n),t.prepend(n),n=t}else if(n.hasChildNodes()){if(i.canvas=n.querySelector("canvas"),!i.canvas)throw"No canvas found in element"}else i.canvas=document.createElement("CANVAS"),n.prepend(i.canvas);i.wrapper=n,i.canvas.height=i.canvas.clientHeight,i.canvas.width=i.canvas.clientWidth,n.classList.add("ndjp"),i.ctx=i.canvas.getContext("2d"),i.fps=s.fps||24,i.loop=s.loop||!1,i.autoplay=s.autoplay||!1,i.showfirst=!1!==s.showfirst,i.path=s.path||"",i.timer=new TimerSrc(1e3/i.fps),i.load()}load(t,e){const s=this;void 0!==e&&(this.src=e,this._frames=[]);const a=new TextDecoder;let i="";return fetch(s.src).then((t=>t.body.getReader())).then((e=>e.read().then((function r({value:n,done:o}){if(o)return t&&t(JSON.parse(i)),void s.onLoad(s);const h=(i+a.decode(n,{stream:!0})).split(/[\r\n](?=.)/);return i=h.pop(),h.map(JSON.parse).forEach((e=>{s.processFrame(e),t&&t(e)})),e.read().then(r)})))).catch((t=>this.onError(t)))}append(t){this._frames.push(t)}prepend(t){this._frames.unshift(t),this.frame++}processFrame(t){const e=this;void 0!==t.w&&(e.canvas.width=t.w),void 0!==t.h&&(e.canvas.height=t.h),void 0!==t.fb&&(e._frameBase=t.fb),void 0!==t.thb&&(e._thumbBase=t.thb),void 0!==t.tf&&(e._numFrames=t.tf),void 0!==t.tt&&(e._totTime=t.tt),void 0!==t.ts&&(e._startTimeStamp||(e._startTimeStamp=t.ts)),void 0!==t.fps&&(e.fps=t.fps,e.timer=new TimerSrc(1e3/e.fps)),void 0!==t.f?(e._frames.push(t),e.loaded||(e.loaded=!0,e.autoplay?e.play():e.showfirst&&e.step())):e.onRender(t),e.started||(e.onStart(e),e.started=!0)}_render(t){if(null==this.timer)throw"TimerSrc was not initialized";if(0===this._frames.length)throw"Video is empty or no frames were found";this.frame>=this._frames.length&&(this.frame=this.loop?0:this._frames.length-1),this.frame<0&&(this.frame=this.loop?this._frames.length-1:0),this._displayImg(t)}_displayImg(t){const e=this,s=e._frames[e.frame],a=function(){e.onRender(s),e.timer.call((function(){e._increment(),t||e.timer.nocall(),e._displayImg()}))};if(void 0!==s.f){const t=e._frameBase+s.f;e._image(t,a)}else e.onRender(s),a()}_increment(){this.frame+=this.multiplier*(this.backwards?-1:1),this.frame<0&&(this.loop?this.frame=this._frames.length-1:(this.frame=0,this.pause(),this.onFinish(this))),this.frame>this._frames.length-1&&(this.loop?this.frame=0:(this.frame=this._frames.length-1,this.pause(),this.onFinish(this)))}_draw=function(t,e){const s=this;return 0===t.width&&0===t.height?(t.onerror(),void 0!==e&&e(!1)):(s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.ctx.drawImage(t,0,0,t.width,t.height,0,0,s.canvas.width,s.canvas.height),void 0!==e&&e(!0)),this};_image=function(t,e){const s=this,a=new Image;return a.crossOrigin="",a.onload=function(){s._draw(a,(function(t){t&&void 0!==e&&e(a)}))},a.onerror=function(){const t=s.onError();t&&(a.src=t)},a.src="/"===t[0]||t.match(/^https?:/)||t.match(/^data:image/)?t:s.path+t,this};frameBase(){return this._frameBase}currentFrame(){return this.frame}totalFrames(){return this._numFrames||this._frames.length}totalTime(){return this._totTime||this.currentFrame()/this.fps}frameAt(t){const e=this;let s=t<this.totalFrames()?e._frames[t]:null;return s&&(s.fb=e._frameBase),s}indexAt(t){return~~(t*this.totalFrames()/100)}playerNode(){return this.wrapper}play(t){t<0?t=0:t>this._frames.length?t=this._frames.length-1:void 0!==t&&(this.frame=1*t),this.playing=!0,this.timer.play(),this._render(!1),this.onPlay(this)}playForward(t){this.backwards=!1,this.play(t)}playBackwards(t){this.backwards=!0,this.play(t)}pause(){this.playing=!1,this.timer.pause(),this.onStop(this)}stop(){this.playing=!1,this.frame=0,this.timer.pause(),this._displayImg(!0),this.onStop(this)}step(t){t<0?t=0:t>this._frames.length?t=this._frames.length-1:void 0!==t&&(this.frame=1*t),this.onPlay(this),this.playing=!1,this.timer.step(),this._render(!0),this.onStop(this)}stepForwards(){this.backwards=!1,this.step()}stepBackwards(){this.backwards=!0,this.step()}reset(){return void 0!==this.ctx.reset&&(this.ctx.reset(),this.ctx.clear(),this.stop(),this.canvas.width=this.canvas.width),this}}
//# sourceMappingURL=ndjson-player.min.js.map
